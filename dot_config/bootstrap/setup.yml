---
- name: Machine setup
  hosts: localhost
  become: true
  connection: local
  gather_facts: true

  tasks:
      - name: Get my user
        ansible.builtin.set_fact:
            remote_regular_user: "{{ ansible_env.SUDO_USER or ansible_user_id }}"

      - name: Update pacman
        community.general.pacman:
            update_cache: yes

      - name: Install base packages
        community.general.pacman:
            name: "{{ item }}"
            state: present
        with_items:
            - base-devel
            - git

      - name: Check if paru is installed
        ansible.builtin.command: "paru -V"
        register: paru_installed
        ignore_errors: yes

      - name: Download paru
        ansible.builtin.command: "git clone https://aur.archlinux.org/paru.git /tmp/paru"
        when: paru_installed.rc != 0

      - name: Install paru
        ansible.builtin.shell: "cd /tmp/paru && makepkg -si --noconfirm"
        when: paru_installed.rc != 0

      - name: Check if Chaotic AUR is installed
        ansible.builtin.command: "paru -S --noconfirm --needed chaotic-keyring"
        register: chaotic_installed
        ignore_errors: yes

      - name: Download Chaotic AUR
        ansible.builtin.shell: "paru -S --noconfirm --needed chaotic-keyring"
        when: chaotic_installed.rc != 0

      - name: Check if Chaotic AUR is in pacman.conf
        ansible.builtin.shell: "grep -q 'chaotic-aur' /etc/pacman.conf"
        register: chaotic_in_pacman
        ignore_errors: yes

      - name: Add Chaotic AUR to pacman.conf
        ansible.builtin.lineinfile:
            path: /etc/pacman.conf
            line: "{{ item }}"
            insertafter: EOF
        with_items:
            - "[chaotic-aur]"
            - "Include = /etc/pacman.d/chaotic-mirrorlist"
        when: chaotic_in_pacman.rc != 0

      - name: Update pacman
        community.general.pacman:
            update_cache: yes

      - name: Install Hyprland
        ansible.builtin.shell: "paru -S --noconfirm --needed {{ item }}"
        with_items:
            - hyprland-git

      - name: Install Docker
        ansible.builtin.shell: "paru -S --noconfirm --needed {{ item }}"
        with_items:
            - docker
            - docker-compose
            - docker-buildx
            - aur/docker-rootless-extras
            - fuse-overlayfs

      - name: install shell dependencies
        ansible.builtin.shell: "paru -S --noconfirm --needed {{ item }}"
        with_items:
            - zsh
            - 
