#!/usr/bin/env bash
set -e

if pacman -Qs virt-manager >/dev/null 2>&1; then
    rebos api echo info "Setting up libvirt"
    sudo usermod -aG libvirt $USER
    sudo usermod -aG kvm $USER
    sudo usermod -aG video $USER

    sudo systemctl enable libvirtd.service --now

    sudo virsh net-autostart default >/dev/null
fi

# Ensure XDG directories are created
rebos api echo info "Creating XDG user directories"
xdg-user-dirs-update

# COPY SYSTEM CONFIGURATIONS
rebos api echo info "Copying system configurations (/etc, /usr, /var)"
sudo cp -r ~/.local/share/chezmoi/confs/* /

# Set java to latest java installed
rebos api echo info "Setting java to the latest installed version"
sudo archlinux-java set $(archlinux-java status |head -n 2|tail -n 1|cut -d ' ' -f 3)

# UPDATE using the update binary in ~/.local/bin
rebos api echo info "Updating all packages and installing any source-only packages"
~/.local/bin/update

# fix rockyou location on archlinux
if [[ ! -f /usr/share/wordlists/rockyou.txt && $(pacman -Qs seclists) == "" ]]; then
    sudo mkdir -p /usr/share/wordlists/
    sudo ln -s /usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt /usr/share/wordlists/rockyou.txt
fi

# Change shell to zsh
# check if zsh is installed and that it is not the users default shell
if [[ $SHELL == "/bin/zsh" ]]; then
    rebos api echo info "zsh is already the default shell not changing"
else
    if ! pacman -Qs zsh >/dev/null 2>&1; then
        rebos api echo error "zsh is not installed..."
    else
        rebos api echo info "Changing shell to zsh"
        chsh -s /bin/zsh
    fi
fi

# WM SPECIFIC CONFIGURATIONS
# Hyprland check if ~/.config/hypr/monitors.conf doesn't exist
if [[ ! -f ~/.config/hypr/monitors.conf ]]; then
    rebos api echo info "Setting up Hyprland monitors"
    cp ~/.config/hypr/monitors/monitors_default.conf ~/.config/hypr/monitors.conf
fi

rebos api echo success "Please reboot to ensure everything was successfully applied"
